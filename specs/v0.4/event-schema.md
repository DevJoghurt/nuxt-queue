# Event Schema - v0.4

> **Version**: v0.4.x  
> **Status**: ✅ Implemented  
> **Last Updated**: 2025-11-04

## Overview

Events are the core of nuxt-queue's event sourcing system. Every flow operation is recorded as an event in Redis Streams, providing a complete audit trail and enabling real-time monitoring.

### Key Principles

- **Immutable**: Events are never modified, only appended
- **Flat structure**: All important fields at top level for easy querying
- **Type-safe**: Strong TypeScript definitions for all event types
- **Self-contained**: Each event has complete context (runId, flowName, stepName)
- **Real-time**: Events published to Redis Pub/Sub for <100ms delivery

## Event Structure

All events share a common base structure with optional step context:

```typescript
interface FlowEvent {
  // Auto-generated by Redis Streams
  id: string              // Redis stream ID (e.g., "1761754554858-0")
  ts: string              // ISO timestamp (e.g., "2025-10-29T16:15:54.834Z")
  
  // Event classification
  type: EventType         // Event type (see types below)
  
  // Flow context (always present)
  runId: string           // Flow run UUID (unique per execution)
  flowName: string        // Flow definition name (e.g., "example-flow")
  
  // Step context (present for step-related events)
  stepName?: string       // Step name (e.g., "first_step")
  stepId?: string         // Unique step execution ID
  attempt?: number        // Retry attempt number (1-based)
  
  // Event-specific payload
  data?: Record<string, any>
}
```

### Field Descriptions

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `id` | string | ✅ | Redis stream ID, auto-generated (timestamp-sequence) |
| `ts` | string | ✅ | ISO 8601 timestamp, auto-generated |
| `type` | EventType | ✅ | Event type identifier |
| `runId` | string | ✅ | Flow run UUID (same as stream name without prefix) |
| `flowName` | string | ✅ | Flow definition name from registry |
| `stepName` | string | ⭕ | Step name (present for step events) |
| `stepId` | string | ⭕ | Unique step execution ID (format: `${runId}__${stepName}__attempt-${attempt}`) |
| `attempt` | number | ⭕ | Retry attempt number, starts at 1 |
| `data` | object | ⭕ | Event-specific payload |

## Event Types

v0.4 defines the following event types:

```typescript
type EventType =
  | 'flow.start'        // Flow execution started
  | 'flow.completed'    // Flow completed successfully
  | 'flow.failed'       // Flow failed
  | 'step.started'      // Step execution started
  | 'step.completed'    // Step completed successfully
  | 'step.failed'       // Step failed
  | 'step.retry'        // Step retry scheduled
  | 'log'               // Log message from worker
  | 'emit'              // Custom event emitted by worker
  | 'state'             // State operation performed
```

### Flow Lifecycle Events

#### flow.start

Emitted when a flow execution begins.

```json
{
  "id": "1761754554858-0",
  "ts": "2025-10-29T16:15:54.834Z",
  "type": "flow.start",
  "runId": "64fc8be3-8adf-459c-a837-5727abd5df94",
  "flowName": "example-flow",
  "data": {
    "input": { "userId": 123, "action": "process" }
  }
}
```

**When**: Called by `useFlowEngine().startFlow()`  
**Contains**: Initial input data for the flow

#### flow.completed

Emitted when a flow completes successfully.

```json
{
  "id": "1761754564858-0",
  "ts": "2025-10-29T16:16:04.834Z",
  "type": "flow.completed",
  "runId": "64fc8be3-8adf-459c-a837-5727abd5df94",
  "flowName": "example-flow",
  "data": {
    "duration": 10000,
    "result": { "status": "success" }
  }
}
```

**When**: All steps completed  
**Contains**: Duration and final result

#### flow.failed

Emitted when a flow fails.

```json
{
  "id": "1761754564858-0",
  "ts": "2025-10-29T16:16:04.834Z",
  "type": "flow.failed",
  "runId": "64fc8be3-8adf-459c-a837-5727abd5df94",
  "flowName": "example-flow",
  "data": {
    "error": "Step validation failed",
    "failedStep": "validate_data"
  }
}
```

**When**: A step fails and exhausts retries  
**Contains**: Error details and failed step

### Step Lifecycle Events

#### step.started

Emitted when a step begins execution.

```json
{
  "id": "1761754554859-0",
  "ts": "2025-10-29T16:15:54.850Z",
  "type": "step.started",
  "runId": "64fc8be3-8adf-459c-a837-5727abd5df94",
  "flowName": "example-flow",
  "stepName": "first_step",
  "stepId": "64fc8be3-8adf-459c-a837-5727abd5df94__first_step__attempt-1",
  "attempt": 1,
  "data": {
    "input": { "userId": 123 }
  }
}
```

**When**: Worker picks up job and starts executing  
**Contains**: Step input data

#### step.completed

Emitted when a step completes successfully.

```json
{
  "id": "1761754564859-0",
  "ts": "2025-10-29T16:16:04.850Z",
  "type": "step.completed",
  "runId": "64fc8be3-8adf-459c-a837-5727abd5df94",
  "flowName": "example-flow",
  "stepName": "first_step",
  "stepId": "64fc8be3-8adf-459c-a837-5727abd5df94__first_step__attempt-1",
  "attempt": 1,
  "data": {
    "result": { "processed": true, "recordCount": 42 }
  }
}
```

**When**: Handler returns successfully  
**Contains**: Step result/return value

#### step.failed

Emitted when a step fails.

```json
{
  "id": "1761754564860-0",
  "ts": "2025-10-29T16:16:04.851Z",
  "type": "step.failed",
  "runId": "64fc8be3-8adf-459c-a837-5727abd5df94",
  "flowName": "example-flow",
  "stepName": "second_step",
  "stepId": "64fc8be3-8adf-459c-a837-5727abd5df94__second_step__attempt-1",
  "attempt": 1,
  "data": {
    "error": "Connection timeout",
    "stack": "Error: Connection timeout\n  at processStep..."
  }
}
```

**When**: Handler throws error  
**Contains**: Error message and stack trace

#### step.retry

Emitted when a step is scheduled for retry.

```json
{
  "id": "1761754564861-0",
  "ts": "2025-10-29T16:16:04.852Z",
  "type": "step.retry",
  "runId": "64fc8be3-8adf-459c-a837-5727abd5df94",
  "flowName": "example-flow",
  "stepName": "fetch_data",
  "stepId": "64fc8be3-8adf-459c-a837-5727abd5df94__fetch_data__attempt-1",
  "attempt": 1,
  "data": {
    "nextAttempt": 2,
    "delay": 5000,
    "reason": "Network error"
  }
}
```

**When**: BullMQ schedules retry after failure  
**Contains**: Next attempt number and delay

### Observability Events

#### log

Emitted when worker logs a message via `ctx.logger.log()`.

```json
{
  "id": "1761754554860-0",
  "ts": "2025-10-29T16:15:54.851Z",
  "type": "log",
  "runId": "64fc8be3-8adf-459c-a837-5727abd5df94",
  "flowName": "example-flow",
  "stepName": "first_step",
  "stepId": "64fc8be3-8adf-459c-a837-5727abd5df94__first_step__attempt-1",
  "attempt": 1,
  "data": {
    "level": "info",
    "message": "Processing item 1/5",
    "progress": 0.2,
    "itemId": "item-123"
  }
}
```

**When**: `ctx.logger.log('info', 'message', { meta })`  
**Contains**: Log level, message, and custom metadata

**Available levels**: `debug`, `info`, `warn`, `error`

#### emit

Emitted when worker triggers a custom event via `ctx.flow.emit()`.

```json
{
  "id": "1761754564861-0",
  "ts": "2025-10-29T16:16:04.852Z",
  "type": "emit",
  "runId": "64fc8be3-8adf-459c-a837-5727abd5df94",
  "flowName": "example-flow",
  "stepName": "first_step",
  "stepId": "64fc8be3-8adf-459c-a837-5727abd5df94__first_step__attempt-1",
  "attempt": 1,
  "data": {
    "name": "data.processed",
    "payload": { "recordCount": 42, "status": "ready" }
  }
}
```

**When**: `ctx.flow.emit('data.processed', payload)`  
**Contains**: Event name and payload for triggering subscribed steps

**Purpose**: Triggers other steps that subscribe to this event name

#### state

Emitted when worker performs state operations via `ctx.state.*`.

```json
{
  "id": "1761754564862-0",
  "ts": "2025-10-29T16:16:04.853Z",
  "type": "state",
  "runId": "64fc8be3-8adf-459c-a837-5727abd5df94",
  "flowName": "example-flow",
  "stepName": "first_step",
  "stepId": "64fc8be3-8adf-459c-a837-5727abd5df94__first_step__attempt-1",
  "attempt": 1,
  "data": {
    "operation": "set",
    "key": "processedRecords",
    "value": 42,
    "ttl": 3600000
  }
}
```

**When**: `ctx.state.set()`, `ctx.state.get()`, or `ctx.state.delete()`  
**Contains**: Operation type, key, and value (for set operations)

**Operations**: `get`, `set`, `delete`

**Operations**: `get`, `set`, `delete`

## Storage and Distribution

### Redis Streams

Events are stored in Redis Streams with one stream per flow run:

```
Stream key: nq:flow:<runId>
```

**Example**:
```bash
# Get all events for a flow run
XRANGE nq:flow:64fc8be3-8adf-459c-a837-5727abd5df94 - +

# Get latest 10 events
XREVRANGE nq:flow:64fc8be3-8adf-459c-a837-5727abd5df94 + - COUNT 10
```

### Flow Index

Flow runs are indexed by flow name for easy listing:

```
Index key: nq:flows:<flowName>  (Sorted Set)
```

**Example**:
```bash
# Get latest 50 runs for a flow
ZREVRANGE nq:flows:example-flow 0 49 WITHSCORES

# Each entry:
# member: runId (UUID)
# score: timestamp (Unix milliseconds)
```

### Real-time Distribution

Events are published to Redis Pub/Sub for real-time delivery:

```
Channel: nq:events:nq:flow:<runId>
```

**Flow**:
1. Event appended to stream (XADD)
2. Event published to Pub/Sub channel (PUBLISH)
3. WebSocket server subscribed to channel receives event
4. Event sent to browser clients via WebSocket (<100ms latency)

## TypeScript Definitions

```typescript
// Base types
type EventType =
  | 'flow.start'
  | 'flow.completed'
  | 'flow.failed'
  | 'step.started'
  | 'step.completed'
  | 'step.failed'
  | 'step.retry'
  | 'log'
  | 'emit'
  | 'state'

interface BaseEvent {
  id: string
  ts: string
  type: EventType
  runId: string
  flowName: string
}

interface StepEvent extends BaseEvent {
  stepName: string
  stepId: string
  attempt: number
}

// Specific event types
interface FlowStartEvent extends BaseEvent {
  type: 'flow.start'
  data: {
    input?: any
  }
}

interface FlowCompletedEvent extends BaseEvent {
  type: 'flow.completed'
  data: {
    duration?: number
    result?: any
  }
}

interface StepStartedEvent extends StepEvent {
  type: 'step.started'
  data: {
    input?: any
  }
}

interface StepCompletedEvent extends StepEvent {
  type: 'step.completed'
  data: {
    result?: any
  }
}

interface StepFailedEvent extends StepEvent {
  type: 'step.failed'
  data: {
    error: string
    stack?: string
  }
}

interface LogEvent extends StepEvent {
  type: 'log'
  data: {
    level: 'debug' | 'info' | 'warn' | 'error'
    message: string
    [key: string]: any  // Custom metadata
  }
}

interface EmitEvent extends StepEvent {
  type: 'emit'
  data: {
    name: string      // Event name for subscription matching
    payload: any      // Data passed to subscribed steps
  }
}

interface StateEvent extends StepEvent {
  type: 'state'
  data: {
    operation: 'get' | 'set' | 'delete'
    key: string
    value?: any
    ttl?: number
  }
}

// Union type
type FlowEvent =
  | FlowStartEvent
  | FlowCompletedEvent
  | StepStartedEvent
  | StepCompletedEvent
  | StepFailedEvent
  | LogEvent
  | EmitEvent
  | StateEvent
```

## Example: Complete Flow Run

Here's a typical sequence of events for a successful flow execution:

```json
[
  {
    "id": "1761754554858-0",
    "ts": "2025-10-29T16:15:54.834Z",
    "type": "flow.start",
    "runId": "64fc8be3-8adf-459c-a837-5727abd5df94",
    "flowName": "example-flow",
    "data": { "input": { "userId": 123 } }
  },
  {
    "id": "1761754554859-0",
    "ts": "2025-10-29T16:15:54.850Z",
    "type": "step.started",
    "runId": "64fc8be3-8adf-459c-a837-5727abd5df94",
    "flowName": "example-flow",
    "stepName": "fetch_user",
    "stepId": "64fc8be3-8adf-459c-a837-5727abd5df94__fetch_user__attempt-1",
    "attempt": 1,
    "data": { "input": { "userId": 123 } }
  },
  {
    "id": "1761754554860-0",
    "ts": "2025-10-29T16:15:54.851Z",
    "type": "log",
    "runId": "64fc8be3-8adf-459c-a837-5727abd5df94",
    "flowName": "example-flow",
    "stepName": "fetch_user",
    "stepId": "64fc8be3-8adf-459c-a837-5727abd5df94__fetch_user__attempt-1",
    "attempt": 1,
    "data": {
      "level": "info",
      "message": "Fetching user from database"
    }
  },
  {
    "id": "1761754555000-0",
    "ts": "2025-10-29T16:15:55.000Z",
    "type": "state",
    "runId": "64fc8be3-8adf-459c-a837-5727abd5df94",
    "flowName": "example-flow",
    "stepName": "fetch_user",
    "stepId": "64fc8be3-8adf-459c-a837-5727abd5df94__fetch_user__attempt-1",
    "attempt": 1,
    "data": {
      "operation": "set",
      "key": "userData",
      "value": { "name": "John Doe", "email": "john@example.com" }
    }
  },
  {
    "id": "1761754564859-0",
    "ts": "2025-10-29T16:16:04.850Z",
    "type": "step.completed",
    "runId": "64fc8be3-8adf-459c-a837-5727abd5df94",
    "flowName": "example-flow",
    "stepName": "fetch_user",
    "stepId": "64fc8be3-8adf-459c-a837-5727abd5df94__fetch_user__attempt-1",
    "attempt": 1,
    "data": { "result": { "ok": true } }
  },
  {
    "id": "1761754564861-0",
    "ts": "2025-10-29T16:16:04.852Z",
    "type": "emit",
    "runId": "64fc8be3-8adf-459c-a837-5727abd5df94",
    "flowName": "example-flow",
    "stepName": "fetch_user",
    "stepId": "64fc8be3-8adf-459c-a837-5727abd5df94__fetch_user__attempt-1",
    "attempt": 1,
    "data": {
      "name": "user.fetched",
      "payload": { "userId": 123 }
    }
  },
  {
    "id": "1761754565000-0",
    "ts": "2025-10-29T16:16:05.000Z",
    "type": "step.started",
    "runId": "64fc8be3-8adf-459c-a837-5727abd5df94",
    "flowName": "example-flow",
    "stepName": "process_user",
    "stepId": "64fc8be3-8adf-459c-a837-5727abd5df94__process_user__attempt-1",
    "attempt": 1,
    "data": { "input": { "userId": 123 } }
  },
  {
    "id": "1761754566000-0",
    "ts": "2025-10-29T16:16:06.000Z",
    "type": "step.completed",
    "runId": "64fc8be3-8adf-459c-a837-5727abd5df94",
    "flowName": "example-flow",
    "stepName": "process_user",
    "stepId": "64fc8be3-8adf-459c-a837-5727abd5df94__process_user__attempt-1",
    "attempt": 1,
    "data": { "result": { "processed": true } }
  },
  {
    "id": "1761754567000-0",
    "ts": "2025-10-29T16:16:07.000Z",
    "type": "flow.completed",
    "runId": "64fc8be3-8adf-459c-a837-5727abd5df94",
    "flowName": "example-flow",
    "data": { 
      "duration": 12166,
      "result": { "status": "success" } 
    }
  }
]
```

## Querying Events

### Common Queries

**Get all events for a flow run**:
```bash
XRANGE nq:flow:64fc8be3-8adf-459c-a837-5727abd5df94 - +
```

**Get events after a specific ID**:
```bash
XRANGE nq:flow:64fc8be3-8adf-459c-a837-5727abd5df94 1761754554860-0 +
```

**Get latest 10 events**:
```bash
XREVRANGE nq:flow:64fc8be3-8adf-459c-a837-5727abd5df94 + - COUNT 10
```

**List all flow runs**:
```bash
ZREVRANGE nq:flows:example-flow 0 -1 WITHSCORES
```

### Client-Side Filtering

Events are typically filtered client-side after retrieval:

```typescript
// Filter by type
const logs = events.filter(e => e.type === 'log')

// Filter by step
const fetchUserEvents = events.filter(e => e.stepName === 'fetch_user')

// Filter by attempt (retries)
const retries = events.filter(e => e.attempt && e.attempt > 1)

// Get only errors
const errors = events.filter(e => 
  e.type === 'step.failed' || 
  (e.type === 'log' && e.data?.level === 'error')
)
```

## Best Practices

### Event Emission

✅ **Use appropriate log levels**:
```typescript
ctx.logger.log('debug', 'Processing details', { itemId })  // Development
ctx.logger.log('info', 'Step milestone reached')           // Important events
ctx.logger.log('warn', 'Retry scheduled', { attempt })     // Warnings
ctx.logger.log('error', 'Operation failed', { error })     // Errors
```

✅ **Include relevant metadata in logs**:
```typescript
ctx.logger.log('info', 'Processing records', {
  total: 100,
  processed: 25,
  progress: 0.25,
  rate: 10  // records per second
})
```

✅ **Use flow.emit() for triggering steps**:
```typescript
// Trigger subscribed steps
ctx.flow.emit('data.processed', { recordCount: 42 })
```

✅ **Document state operations**:
```typescript
await ctx.state.set('lastProcessedId', id, { ttl: 3600000 })
```

### Event Consumption

✅ **Use WebSocket for real-time updates**:
```typescript
// Subscribe to flow events via WebSocket
const { subscribe, connected, reconnecting } = useFlowWebSocket()

subscribe(
  {
    flowName: 'example-flow',
    runId: '64fc8be3-8adf-459c-a837-5727abd5df94',
    onEvent: (event) => {
      // Handle individual event
      console.log('Event:', event.type, event)
    },
    onHistory: (events) => {
      // Handle historical events (backfill)
      console.log('History:', events.length, 'events')
    }
  },
  {
    autoReconnect: true,
    maxRetries: 10
  }
)

// Connection state
console.log('Connected:', connected.value)
console.log('Reconnecting:', reconnecting.value)
```

✅ **Reduce events to state**:
```typescript
const state = events.reduce((acc, event) => {
  switch (event.type) {
    case 'step.started':
      acc.steps[event.stepName] = { status: 'running', startedAt: event.ts }
      break
    case 'step.completed':
      acc.steps[event.stepName].status = 'completed'
      acc.steps[event.stepName].completedAt = event.ts
      break
  }
  return acc
}, { steps: {} })
```

### Performance

- **Stream trimming**: Configure `maxLen` in eventStore options to limit stream size
- **Batch reads**: Read events in chunks when processing large streams
- **Client-side caching**: Cache events on client to reduce API calls
- **WebSocket backfill**: Use XRANGE for historical events before subscribing to WebSocket updates

## Related Documentation

- **[Current Implementation](./current-implementation.md)** - Complete v0.4 architecture
- **[Quick Reference](./quick-reference.md)** - API patterns and examples
- **[Flow Scheduling](./flow-scheduling.md)** - Scheduling flows guide

---

**Version**: v0.4.x  
**Status**: ✅ Implemented  
**Last Updated**: 2025-11-04
