# v0.4 Event Schema Proposal

## Problems with Current v0.3 Schema

### 1. Inconsistent ID Fields
- `subject` sometimes contains flowId (UUID)
- `flow` field contains flow name OR flowId (inconsistent!)
- `meta.flowId` duplicates the subject
- `data.flowId` sometimes present

### 2. Confusing Terminology
- "subject" is unclear (borrowed from message bus, not intuitive)
- "flow" is ambiguous (is it the flow name or flow run ID?)
- "kind" vs "type" inconsistency

### 3. Nested Complexity
- Step context buried in `meta` object
- Important fields like `stepKey`, `attempt` hidden
- Hard to query/filter events

## Inspiration from Motia

Motia uses a clear hierarchy:
```
Trace Group (MCJH1-3846140)
  └─ Step Trace (f705e72d-9945-4638-abbf-fa495ad793e0)
      ├─ parentTraceId: MCJH1-3846140
      ├─ name: "ApiTrigger"
      └─ events: [
          { type: "log", timestamp, message, metadata }
          { type: "emit", timestamp, topic, data }
          { type: "state", timestamp, operation, data }
        ]
```

**Key Insights:**
- Clear parent-child relationship via `parentTraceId`
- Events are typed: `log`, `emit`, `state`
- Flat structure with consistent fields
- Metadata separate from core fields

## Proposed v0.4 Schema

### Core Event Structure

```typescript
interface FlowEvent {
  // Auto-generated by Redis
  id: string              // Redis stream ID (e.g., "1761754554858-0")
  ts: string              // ISO timestamp (e.g., "2025-10-29T16:15:54.834Z")
  
  // Event type
  type: EventType         // 'flow.start' | 'step.started' | 'step.completed' | 'log' | 'emit' | 'state'
  
  // Run context (always present)
  runId: string           // Flow run UUID (same as stream name)
  flowName: string        // Flow definition name (e.g., "example-flow")
  
  // Step context (present for step-related events)
  stepName?: string       // Step name (e.g., "first_step")
  stepId?: string         // Unique step execution ID (for retries: "${runId}__${stepName}__attempt-${attempt}")
  attempt?: number        // Attempt number (1-based)
  
  // Event payload (type-specific)
  data?: Record<string, any>
}
```

### Event Types

#### 1. Flow Events

**flow.start**
```json
{
  "id": "1761754554858-0",
  "ts": "2025-10-29T16:15:54.834Z",
  "type": "flow.start",
  "runId": "64fc8be3-8adf-459c-a837-5727abd5df94",
  "flowName": "example-flow",
  "data": {
    "input": { /* initial payload */ }
  }
}
```

**flow.completed**
```json
{
  "id": "1761754564858-0",
  "ts": "2025-10-29T16:16:04.834Z",
  "type": "flow.completed",
  "runId": "64fc8be3-8adf-459c-a837-5727abd5df94",
  "flowName": "example-flow",
  "data": {
    "result": { /* final result */ }
  }
}
```

#### 2. Step Events

**step.started**
```json
{
  "id": "1761754554859-0",
  "ts": "2025-10-29T16:15:54.850Z",
  "type": "step.started",
  "runId": "64fc8be3-8adf-459c-a837-5727abd5df94",
  "flowName": "example-flow",
  "stepName": "first_step",
  "stepId": "64fc8be3-8adf-459c-a837-5727abd5df94__first_step__attempt-1",
  "attempt": 1,
  "data": {
    "input": { /* step input */ }
  }
}
```

**step.completed**
```json
{
  "id": "1761754564859-0",
  "ts": "2025-10-29T16:16:04.850Z",
  "type": "step.completed",
  "runId": "64fc8be3-8adf-459c-a837-5727abd5df94",
  "flowName": "example-flow",
  "stepName": "first_step",
  "stepId": "64fc8be3-8adf-459c-a837-5727abd5df94__first_step__attempt-1",
  "attempt": 1,
  "data": {
    "result": { "ok": true }
  }
}
```

**step.failed**
```json
{
  "id": "1761754564860-0",
  "ts": "2025-10-29T16:16:04.851Z",
  "type": "step.failed",
  "runId": "64fc8be3-8adf-459c-a837-5727abd5df94",
  "flowName": "example-flow",
  "stepName": "second_step",
  "stepId": "64fc8be3-8adf-459c-a837-5727abd5df94__second_step__attempt-1",
  "attempt": 1,
  "data": {
    "error": "Connection timeout",
    "stack": "..."
  }
}
```

#### 3. Log Events

**log**
```json
{
  "id": "1761754554860-0",
  "ts": "2025-10-29T16:15:54.851Z",
  "type": "log",
  "runId": "64fc8be3-8adf-459c-a837-5727abd5df94",
  "flowName": "example-flow",
  "stepName": "first_step",
  "stepId": "64fc8be3-8adf-459c-a837-5727abd5df94__first_step__attempt-1",
  "attempt": 1,
  "data": {
    "level": "info",
    "message": "Processing item 1/5",
    "progress": 1
  }
}
```

#### 4. Action Events (Motia-inspired)

**emit** (trigger event for other steps)
```json
{
  "id": "1761754564861-0",
  "ts": "2025-10-29T16:16:04.852Z",
  "type": "emit",
  "runId": "64fc8be3-8adf-459c-a837-5727abd5df94",
  "flowName": "example-flow",
  "stepName": "first_step",
  "stepId": "64fc8be3-8adf-459c-a837-5727abd5df94__first_step__attempt-1",
  "attempt": 1,
  "data": {
    "topic": "process-order",
    "payload": { "orderId": 123 }
  }
}
```

**state** (state operation)
```json
{
  "id": "1761754564862-0",
  "ts": "2025-10-29T16:16:04.853Z",
  "type": "state",
  "runId": "64fc8be3-8adf-459c-a837-5727abd5df94",
  "flowName": "example-flow",
  "stepName": "first_step",
  "stepId": "64fc8be3-8adf-459c-a837-5727abd5df94__first_step__attempt-1",
  "attempt": 1,
  "data": {
    "operation": "set",
    "scope": "orders",
    "key": "order-123",
    "value": { "status": "processed" }
  }
}
```

## Benefits

### 1. Clarity
- `runId`: Always the flow execution UUID
- `flowName`: Always the flow definition name
- `stepName`: Always the step name (not buried in meta)
- No confusion between identifiers

### 2. Consistency
- Same top-level fields for all events
- Optional step context when relevant
- Type-specific data in `data` field only

### 3. Queryability
- Easy to filter by step: `WHERE stepName = 'first_step'`
- Easy to find retries: `WHERE attempt > 1`
- Easy to get logs: `WHERE type = 'log'`

### 4. Extensibility
- New event types easy to add
- Type-specific data doesn't pollute top level
- Compatible with Motia's approach

## Migration Path

### Phase 1: Update Event Bus & Wiring
1. Change event emission to use new schema
2. Update flowWiring to persist new schema
3. Keep backward compatibility by accepting both formats

### Phase 2: Update Worker & Plugins
1. Update worker emit to use new schema
2. Update flows plugin to read new schema
3. Update useLogs to emit new schema

### Phase 3: Update API & Client
1. Update SSE endpoints to return new schema
2. Update client-side reducers to process new schema
3. Remove old schema support

## Redis Structure

### Stream Name
```
nq:flow:<runId>
```

### Index
```
nq:flows:<flowName>  → ZSET of runId by timestamp
```

### Example
```bash
# Stream
nq:flow:64fc8be3-8adf-459c-a837-5727abd5df94

# Index
nq:flows:example-flow → [
  "64fc8be3-8adf-459c-a837-5727abd5df94" (score: 1761754554834)
  "f724cca4-8d0c-4340-b31a-7f6bbc948ebc" (score: 1761752551572)
]
```

## TypeScript Definitions

```typescript
type EventType =
  | 'flow.start'
  | 'flow.completed'
  | 'flow.failed'
  | 'step.started'
  | 'step.completed'
  | 'step.failed'
  | 'step.retry'
  | 'log'
  | 'emit'
  | 'state'

interface BaseEvent {
  id: string
  ts: string
  type: EventType
  runId: string
  flowName: string
}

interface StepEvent extends BaseEvent {
  stepName: string
  stepId: string
  attempt: number
}

interface FlowStartEvent extends BaseEvent {
  type: 'flow.start'
  data: {
    input?: any
  }
}

interface LogEvent extends StepEvent {
  type: 'log'
  data: {
    level: 'debug' | 'info' | 'warn' | 'error'
    message: string
    [key: string]: any
  }
}

interface EmitEvent extends StepEvent {
  type: 'emit'
  data: {
    topic: string
    payload: any
  }
}

interface StateEvent extends StepEvent {
  type: 'state'
  data: {
    operation: 'get' | 'set' | 'delete'
    scope?: string
    key: string
    value?: any
  }
}

type FlowEvent =
  | FlowStartEvent
  | LogEvent
  | EmitEvent
  | StateEvent
  // ... other event types
```

## Example Flow Run

```json
[
  {
    "id": "1761754554858-0",
    "ts": "2025-10-29T16:15:54.834Z",
    "type": "flow.start",
    "runId": "64fc8be3-8adf-459c-a837-5727abd5df94",
    "flowName": "example-flow",
    "data": { "input": { "userId": 123 } }
  },
  {
    "id": "1761754554859-0",
    "ts": "2025-10-29T16:15:54.850Z",
    "type": "step.started",
    "runId": "64fc8be3-8adf-459c-a837-5727abd5df94",
    "flowName": "example-flow",
    "stepName": "first_step",
    "stepId": "64fc8be3-8adf-459c-a837-5727abd5df94__first_step__attempt-1",
    "attempt": 1,
    "data": { "input": { "userId": 123 } }
  },
  {
    "id": "1761754554860-0",
    "ts": "2025-10-29T16:15:54.851Z",
    "type": "log",
    "runId": "64fc8be3-8adf-459c-a837-5727abd5df94",
    "flowName": "example-flow",
    "stepName": "first_step",
    "stepId": "64fc8be3-8adf-459c-a837-5727abd5df94__first_step__attempt-1",
    "attempt": 1,
    "data": {
      "level": "info",
      "message": "Processing user 123"
    }
  },
  {
    "id": "1761754564859-0",
    "ts": "2025-10-29T16:16:04.850Z",
    "type": "step.completed",
    "runId": "64fc8be3-8adf-459c-a837-5727abd5df94",
    "flowName": "example-flow",
    "stepName": "first_step",
    "stepId": "64fc8be3-8adf-459c-a837-5727abd5df94__first_step__attempt-1",
    "attempt": 1,
    "data": { "result": { "ok": true } }
  },
  {
    "id": "1761754564860-0",
    "ts": "2025-10-29T16:16:04.851Z",
    "type": "flow.completed",
    "runId": "64fc8be3-8adf-459c-a837-5727abd5df94",
    "flowName": "example-flow",
    "data": { "result": { "status": "success" } }
  }
]
```
